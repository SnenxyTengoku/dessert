# recipe by askpng
# https://github.com/askpng/solarpowered/blob/main/recipes/kernels/bazzite.yml

modules:
  - type: script
    snippets:
      - dnf -y remove kernel-* &&
          rm -drf /usr/lib/modules/*
      # ---
      # RPM method
      # ---
      - OS_VERSION=$(rpm -E %fedora) &&
        VER=$(basename $(curl -Ls -o /dev/null -w %{url_effective} https://github.com/bazzite-org/kernel-bazzite/releases/latest)) && 
        dnf install -y
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-common-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-core-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-devel-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-devel-matched-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-modules-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-modules-akmods-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-modules-core-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-modules-extra-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-modules-extra-matched-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-modules-internal-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-tools-$VER.fc$OS_VERSION.x86_64.rpm
            https://github.com/bazzite-org/kernel-bazzite/releases/download/$VER/kernel-tools-libs-$VER.fc$OS_VERSION.x86_64.rpm
      # ---
      # Extraction method
      # ---
      # # 1. Download & extract kernel.tar.zst from Bazzite GH releases
      # - TAG=$(basename $(curl -Ls -o /dev/null -w %{url_effective} https://github.com/bazzite-org/kernel-bazzite/releases/latest)) &&
      #     VER=$(echo "$TAG" | sed 's/\(.*\)-/\1./') &&
      #     OS_VERSION=$(rpm -E %fedora) &&
      #     curl --retry 5 -L "https://github.com/bazzite-org/kernel-bazzite/releases/download/$TAG/linux-bazzite-$VER.fc$OS_VERSION-1-x86_64.pkg.tar.zst" -o /tmp/kernel.tar.zst
      # # 2. Copy kernel.tar.zst contents to /
      # - tar xf /tmp/kernel.tar.zst -C /tmp
      # - cp -r /tmp/usr /
      # # 3. Run depmod -a
      # - VER=$(ls /usr/lib/modules) &&
      #     depmod -a $VER
      # # 4. Generate and verify initramfs.img
      # - VER=$(ls /usr/lib/modules) && 
      #     dracut --kver $VER --force --add ostree --no-hostonly --reproducible /usr/lib/modules/$VER/initramfs.img &&
      #     find /usr/lib/modules/$VER/initramfs.img
      # # 5. Cleanup
      # - rm -r /tmp/usr &&
      #     rm /tmp/kernel.tar.zst      

  - type: dnf
    replace:
      - from-repo: copr:copr.fedorainfracloud.org:bazzite-org:bazzite
        skip-unavailable: true
        packages:
          # use bazzite's firmwares
          # see https://github.com/ublue-os/bazzite/blob/main/build_files/install-firmware
          - amd-gpu-firmware
          - amd-ucode-firmware
          - atheros-firmware
          - brcmfmac-firmware
          - cirrus-audio-firmware
          - intel-audio-firmware
          - intel-gpu-firmware
          - intel-vsc-firmware
          - iwlegacy-firmware
          - iwlwifi-dvm-firmware
          - iwlwifi-mvm-firmware
          - libertas-firmware
          - linux-firmware
          - linux-firmware-whence
          - mt7xxx-firmware
          - nvidia-gpu-firmware
          - nxpwireless-firmware
          - qcom-wwan-firmware
          - realtek-firmware
          - tiwilink-firmware

  - type: script
    snippets:
      - git clone https://github.com/hhd-dev/hwfirm /tmp/hwfirm --depth 1 &&
        cp -r /tmp/hwfirm/cirrus/* /usr/lib/firmware/cirrus/ &&
        cp -r /tmp/hwfirm/rtl_bt/* /usr/lib/firmware/rtl_bt/ &&
        cp -r /tmp/hwfirm/awinic/* /usr/lib/firmware/ &&
        cp -r /tmp/hwfirm/tas/*    /usr/lib/firmware/ &&
        cp -r /tmp/hwfirm/xone/xow* /usr/lib/firmware/ &&
        rm -rf /tmp/hwfirm/ &&
        rm /usr/lib/firmware/rtl_bt/rtl8822cu_config.bin.xz

  - type: dnf
    repos:
      cleanup: true
      copr:
        - bieszczaders/kernel-cachyos-addons
    install:
      install-weak-deps: false
      packages:
        - scx-scheds-git
        - scx-manager

  - type: systemd
    system:
      enabled:
      - scx_loader.service